# =============================================================================
# BUILD IMAGE
# =============================================================================
FROM python:3.12-alpine AS build
# -----------------------------------------------------------------------------
# COPY PRE-BUILT PACKAGES (OPTIONAL)
# -----------------------------------------------------------------------------
#COPY pkg /pkg
# -----------------------------------------------------------------------------
# COPY TEMPLATES
# -----------------------------------------------------------------------------
COPY tpl /tpl
# -----------------------------------------------------------------------------
# SETUP VENV
# -----------------------------------------------------------------------------
RUN apk add build-base zip linux-headers && \
    python3 -m venv /venv && \
    /venv/bin/python -m pip install uv && \
    /venv/bin/uv pip install --python /venv/bin/python argon2-cffi python-keycloak edf-helium-server && \
    /venv/bin/generaptor --cache /tpl/generaptor/cache update && \
    cd /tpl && \
    zip generaptor.zip generaptor/ && \
    rm -rf generaptor/
# =============================================================================
# PRODUCTION IMAGE
# =============================================================================
FROM python:3.12-alpine AS production
# -----------------------------------------------------------------------------
# ADD DEPENDENCIES
# -----------------------------------------------------------------------------
RUN apk add unzip
# -----------------------------------------------------------------------------
# COPY FROM BUILD IMAGE
# -----------------------------------------------------------------------------
COPY --from=build /tpl /tpl
COPY --from=build /venv /venv
# -----------------------------------------------------------------------------
# ENTRYPOINT
# -----------------------------------------------------------------------------
COPY --chmod=755 docker-entrypoint.sh /docker-entrypoint.sh
ENTRYPOINT ["/docker-entrypoint.sh"]
